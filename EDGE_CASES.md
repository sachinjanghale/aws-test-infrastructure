# Edge Cases and Special Configurations

This document describes the edge cases and special configurations included in the infrastructure for comprehensive testing of the infrasyn.app migration tool.

## SSH Key Pair for EC2

### Overview
The infrastructure automatically creates an SSH key pair for EC2 instance access, mimicking real-world scenarios where instances need SSH access.

### Resources Created
- **TLS Private Key**: 4096-bit RSA key generated by Terraform
- **AWS Key Pair**: Public key uploaded to AWS
- **Local Private Key File**: `{project_name}-ec2-key.pem` saved in project root with 0400 permissions

### Usage
```bash
# Get EC2 public IP
EC2_IP=$(terraform output -raw ec2_instance_public_ip)

# Connect via SSH
ssh -i aws-test-infra-ec2-key.pem ec2-user@$EC2_IP
```

### Security Notes
- Private key file is automatically added to `.gitignore`
- File permissions are set to 0400 (read-only for owner)
- Key is stored in Terraform state (sensitive)
- For production, use AWS Systems Manager Session Manager instead

### Testing Value
This tests the migration tool's ability to:
- Detect and export key pair resources
- Handle key pair associations with EC2 instances
- Preserve key pair references in generated Terraform code

## IAM Role with Multiple S3 Policies

### Overview
The EC2 instance has TWO separate IAM policies for S3 access, representing a common real-world pattern where instances have both general and specific permissions.

### Policy 1: Limited S3 Access (Inline Policy)
```json
{
  "Effect": "Allow",
  "Action": [
    "s3:GetObject",
    "s3:PutObject",
    "s3:ListBucket"
  ],
  "Resource": [
    "arn:aws:s3:::aws-test-infra-*",
    "arn:aws:s3:::aws-test-infra-*/*"
  ]
}
```

### Policy 2: Full S3 Access to Encrypted Bucket (Separate Inline Policy)
```json
{
  "Effect": "Allow",
  "Action": ["s3:*"],
  "Resource": [
    "arn:aws:s3:::aws-test-infra-encrypted-*",
    "arn:aws:s3:::aws-test-infra-encrypted-*/*"
  ]
}
```

### Why This Matters
This configuration tests:
- Multiple inline policies on a single role
- Overlapping permissions (encrypted bucket has both limited and full access)
- Wildcard actions (s3:*)
- Resource-specific permissions

### Real-World Scenario
This mimics scenarios where:
- An instance needs general read/write access to application buckets
- The same instance needs full control over a specific backup/archive bucket
- Permissions evolved over time, resulting in overlapping policies

## IAM Users, Groups, and Policy Attachments

### Overview
The infrastructure creates a complex IAM user/group structure to test various policy attachment methods.

### Resources Created

#### IAM Group: `developers`
- **Managed Policy**: `ReadOnlyAccess` (AWS managed)
- **Inline Policy**: Custom policy for S3 ListBucket and GetObject

#### IAM User: `test-user1`
- **Group Membership**: `developers`
- **Inline Policy**: DynamoDB GetItem and Query permissions
- **Access Key**: Created for API access testing

#### IAM User: `test-user2`
- **Group Membership**: `developers`
- **Attached Policy**: Custom managed policy for CloudWatch Logs

#### Standalone IAM Policy: `custom-policy`
- CloudWatch Logs permissions
- Attached to `test-user2`

### Policy Attachment Methods Tested
1. **Managed Policy to Group**: `aws_iam_group_policy_attachment`
2. **Inline Policy to Group**: `aws_iam_group_policy`
3. **Inline Policy to User**: `aws_iam_user_policy`
4. **Managed Policy to User**: `aws_iam_user_policy_attachment`
5. **Group Membership**: `aws_iam_user_group_membership`

### Testing Value
This tests the migration tool's ability to:
- Detect all policy attachment methods
- Preserve group memberships
- Handle both inline and managed policies
- Export access keys (with proper security warnings)
- Reconstruct the complete permission hierarchy

## Additional Edge Cases

### S3 Bucket Configurations
- **Versioned Bucket**: Lifecycle policies, versioning, logging
- **Encrypted Bucket**: KMS encryption, server-side encryption configuration
- **Force Destroy**: Both buckets have `force_destroy = true` for testing

### Launch Configuration vs Launch Template
- Both resources created to test deprecated vs current patterns
- Launch Configuration: Deprecated but still widely used
- Launch Template: Current best practice

### Lambda Configurations
- **Event Source Mapping**: SQS trigger for Lambda
- **Event Invoke Config**: Retry and DLQ configuration
- **Lambda Layer**: Shared code layer

### API Gateway Resources
- **Authorizer**: Token-based authorizer
- **API Key**: Usage plan with quotas and throttling
- **VPC Link**: Optional (disabled by default due to cost)
- **Gateway Response**: Custom error responses
- **Documentation**: API documentation parts

### Network ACLs
- Public subnet NACL with specific ingress/egress rules
- Private subnet NACL with different rule sets
- Tests NACL rule ordering and numbering

## Cost Impact

All edge cases are designed to stay within free tier or minimal cost:
- **TLS Key Pair**: Free (generated by Terraform)
- **IAM Resources**: Free (users, groups, policies, roles)
- **Additional IAM Policies**: Free
- **Launch Configuration**: Free
- **Lambda Layer**: Free (within Lambda free tier)
- **API Gateway Resources**: Free (within API Gateway free tier)
- **Network ACLs**: Free

**Total Additional Cost**: $0.00/month

## Migration Tool Testing Checklist

Use this checklist to verify the migration tool handles all edge cases:

- [ ] SSH key pair detected and exported
- [ ] Key pair association with EC2 preserved
- [ ] Multiple inline policies on EC2 role detected
- [ ] Overlapping S3 permissions handled correctly
- [ ] IAM group with both managed and inline policies
- [ ] IAM users with group memberships
- [ ] IAM users with both inline and attached policies
- [ ] Access keys detected (with security warnings)
- [ ] Standalone IAM policies and attachments
- [ ] Both launch configuration and launch template
- [ ] Lambda event source mapping
- [ ] Lambda event invoke config
- [ ] Lambda layer version
- [ ] API Gateway authorizer
- [ ] API Gateway usage plan and API key
- [ ] API Gateway documentation parts
- [ ] Network ACLs with rule ordering
- [ ] S3 lifecycle policies
- [ ] S3 versioning configuration
- [ ] S3 logging configuration
- [ ] Force destroy flags on S3 buckets

## Security Considerations

### Private Key Storage
- Private key is stored in Terraform state (encrypted if using S3 backend)
- Private key file is created locally (added to .gitignore)
- For production, use AWS Systems Manager Session Manager instead

### IAM Access Keys
- Access key is created for `test-user1`
- Secret access key is stored in Terraform state
- For production, rotate keys regularly and use IAM roles instead

### Overlapping Permissions
- EC2 has both limited and full S3 access to encrypted bucket
- This is intentional for testing but should be cleaned up in production
- Follow principle of least privilege

## Cleanup

When destroying the infrastructure:
```bash
# Remove private key file
rm -f aws-test-infra-ec2-key.pem

# Destroy infrastructure
terraform destroy
```

The private key file will be automatically deleted by Terraform, but you can manually remove it if needed.
